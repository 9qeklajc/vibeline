name: yolopost
description: Post to nostr when trigger words are detected
run: matching
keywords: ["test", "post", "good", "morning", "showing", "wife"]
match: all
output_extension: ".json"
command: |
  # Read the title from title plugin output
  title_file="VoiceMemos/transcripts/$(basename AUDIO_FILE .m4a)_title.txt"
  title=""
  if [ -f "$title_file" ]; then
    title=$(cat "$title_file" | tr -d '\n\r')
  fi
  
  # Read the upload link from blossom plugin output using jq
  blossom_file="VoiceMemos/transcripts/$(basename AUDIO_FILE .m4a)_blossom.json"
  upload_link=""
  if [ -f "$blossom_file" ]; then
    upload_link=$(jq -r '.url // .link // .href // empty' "$blossom_file" 2>/dev/null)
  fi
  
  # Check if both title and upload link are available
  if [ -z "$title" ]; then
    echo "Error: Title file not found or empty: $title_file" >&2
    exit 1
  fi
  
  if [ -z "$upload_link" ]; then
    echo "Error: Upload link not found in blossom output: $blossom_file" >&2
    exit 1
  fi
  
  # Combine title and upload link
  echo "$title" > /tmp/yolopost_content.txt
  echo "$upload_link" >> /tmp/yolopost_content.txt
  cat /tmp/yolopost_content.txt | nak publish --sec $YOLOPOST_NSEC $RELAYS
  rm -f /tmp/yolopost_content.txt
